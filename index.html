<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocoTotal OS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --background: #050505;
            --surface: #111111;
            --surface-2: #1c1c1c;
            --primary-glow: #818cf8;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --text-primary: #f9fafb;
            --text-secondary: #a1a1aa;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --font-family: 'Inter', sans-serif;
            --success: #4ade80;
            --warning: #facc15;
            --danger: #f87171;
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --app-padding: 16px;

            --context-trabalho: #3b82f6;
            --context-freela: #ef4444;
            --context-faculdade: #f97316;
            
            --ui-density-gap: 12px;
            --ui-density-padding: 12px;
        }
        
        body.ui-density-compact {
             --ui-density-gap: 8px;
             --ui-density-padding: 8px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes modalPopIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes skeleton-shine { 0% { background-position: -200px 0; } 100% { background-position: calc(200px + 100%) 0; } }

        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--background);
            color: var(--text-primary);
            overscroll-behavior: none;
            background: radial-gradient(circle at top left, rgba(99, 102, 241, 0.15), transparent 30%),
                        radial-gradient(circle at bottom right, rgba(239, 68, 68, 0.1), transparent 40%),
                        var(--background);
        }

        #app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- Login Screen --- */
        .login-container { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%; gap: 24px; padding: 20px; text-align: center; }
        .login-card { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); padding: 40px 24px; border-radius: 24px; width: 100%; max-width: 380px; }
        .login-container h1 { font-size: 2.5rem; color: var(--text-primary); font-weight: 800; margin:0 0 8px; }
        .login-container p { color: var(--text-secondary); margin-bottom: 32px; }
        .login-form { display: flex; flex-direction: column; gap: 16px; }
        .login-form input { padding: 14px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); border-radius: 10px; font-size: 1rem; }
        .login-form button { padding: 14px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .login-form button:hover { background: var(--primary-hover); }
        .dev-login-btn { background: var(--surface-2) !important; color: var(--text-secondary) !important; }
        .dev-login-btn:hover { background: var(--border-color) !important; }

        /* --- Toast --- */
        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); color: white; padding: 12px 24px; border-radius: 10px; box-shadow: 0 4px 25px var(--shadow-color); opacity: 0; visibility: hidden; transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); z-index: 1002; display: flex; align-items: center; gap: 8px; }
        #toast.show { opacity: 1; visibility: visible; bottom: 90px; }
        #toast.success { background-color: var(--success); color: black; border: none;}
        
        /* --- App Shell --- */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 12px var(--app-padding); background-color: rgba(5,5,5,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); flex-shrink: 0; z-index: 998; position: sticky; top: 0; animation: fadeIn 0.5s; }
        .logo { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.5px; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .xp-bar-container { width: 120px; display: flex; flex-direction: column; gap: 4px; }
        .xp-info { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-secondary); }
        .xp-bar-track { height: 6px; background-color: var(--surface-2); border-radius: 3px; overflow: hidden; }
        .xp-bar { height: 100%; background: linear-gradient(to right, var(--primary), var(--primary-glow)); transition: width 0.5s ease-out; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary); cursor: pointer; display:flex; align-items:center; justify-content:center; font-weight:bold; border: 2px solid var(--surface-2); transition: transform 0.2s; }
        .user-avatar:hover { transform: scale(1.1); }
        .main-content { flex-grow: 1; overflow-y: auto; padding: var(--app-padding); padding-bottom: 100px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; margin: 0 auto var(--app-padding); width: calc(100% - var(--app-padding)*2); max-width: 400px; display: flex; justify-content: space-around; background-color: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); z-index: 999; border-radius: 28px; padding: 8px; animation: slideUp 0.5s ease-out; }
        .bottom-nav button { background: none; border: none; color: var(--text-secondary); font-size: 1rem; padding: 8px 12px; cursor: pointer; flex-direction: column; display: flex; align-items: center; gap: 4px; transition: all 0.2s; font-size: 0.75rem; position: relative; }
        .bottom-nav button svg { width: 24px; height: 24px; }
        .bottom-nav button.active { color: var(--text-primary); }
        .bottom-nav button.active::after { content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--primary-glow); border-radius: 50%; }

        /* --- Dashboard --- */
        .dashboard-grid { display: grid; gap: var(--app-padding); animation: slideUp 0.5s ease-out forwards; }
        .card { background: var(--glass-bg); border: 1px solid var(--glass-border); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 24px; border-radius: 20px; }
        .focus-card h1 { margin: 0; font-size: 2.5rem; font-weight: 800; }
        .focus-card p { color: var(--text-secondary); margin: 4px 0 24px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center; }
        .stat-item h4 { margin: 0 0 4px; font-size: 1.75rem; font-weight: 700; color: var(--primary-glow); }
        .stat-item p { margin: 0; font-size: 0.8rem; color: var(--text-secondary); }
        .quick-add-form { display: flex; gap: 8px; margin-top: 24px; }
        .quick-add-form input { flex-grow: 1; background: var(--surface-2); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; color: var(--text-primary); }
        .quick-add-form button { background: var(--primary); border: none; border-radius: 10px; padding: 0 16px; color: white; cursor: pointer; }

        /* --- Kanban --- */
        .kanban-board { display: grid; gap: 24px; }
        .kanban-column { background-color: transparent; border-radius: 16px; flex-shrink: 0; }
        .kanban-column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 8px; }
        .kanban-column-header h2 { margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-primary); text-transform: capitalize; letter-spacing: 0.5px; }
        .clear-done-btn:hover { color: var(--danger); background-color: rgba(248, 113, 113, 0.1); }
        .task-cards-container { display: flex; flex-direction: column; gap: var(--ui-density-gap); min-height: 100px; border-radius: 12px; transition: background-color 0.2s; }
        .task-cards-container.drag-over-active { background-color: rgba(99, 102, 241, 0.1); }
        .empty-column-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); font-size: 0.9rem; border: 2px dashed var(--surface-2); border-radius: 12px; }
        .task-card { background-color: var(--surface-2); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; animation: slideUp 0.4s ease-out; }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); border-color: var(--primary); }
        .task-card.dragging { opacity: 0.5; transform: rotate(3deg); box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
        .task-card.is-moving { transition: none; } /* Disable transition while rearranging */
        .task-card h3 { margin: 0 0 8px; font-size: 1rem; font-weight: 500; }
        .task-card .description-snippet { font-size: 0.9rem; color: var(--text-secondary); margin: 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-header h3 { flex-grow: 1; }
        .complete-task-btn { background: none; border: 2px solid var(--text-secondary); color: var(--text-secondary); border-radius: 50%; width: 24px; height: 24px; padding: 0; cursor: pointer; transition: all 0.2s; flex-shrink: 0; margin-left: 8px; }
        .complete-task-btn:hover { background-color: var(--success); color: black; border-color: var(--success); }
        .task-footer { display: flex; align-items: center; margin-top: 12px; }
        .context-tag { font-size: 0.75rem; font-weight: 500; padding: 4px 10px; border-radius: 16px; color: var(--text-primary); }

        /* Kanban Desktop */
        @media (min-width: 768px) {
            .main-content { padding-bottom: var(--app-padding); }
            .kanban-board {
                grid-auto-flow: column;
                grid-auto-columns: 300px;
                overflow-x: auto;
                padding-bottom: 20px;
            }
        }
        
        /* Skeleton Loader */
        .skeleton { background-color: var(--surface-2); border-radius: 12px; background: linear-gradient(90deg, var(--surface-2) 25%, var(--surface) 50%, var(--surface-2) 75%); background-size: 200px 100%; animation: skeleton-shine 1.5s infinite linear; }
        .skeleton-card { height: 120px; margin-bottom: 12px; }
        .skeleton-header { height: 40px; width: 60%; margin-bottom: 16px; border-radius: 8px; }

        /* --- FAB & Modals --- */
        .fab { position: fixed; bottom: 95px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(45deg, var(--primary), var(--primary-glow)); color: white; border: none; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 25px var(--shadow-color); cursor: pointer; transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1); z-index: 1000; }
        .fab:hover { filter: brightness(1.1); transform: scale(1.08) rotate(90deg); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1001; }
        @media (min-width: 768px) { .modal-overlay { align-items: center; } }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background: var(--glass-bg); border-top: 1px solid var(--glass-border); padding: 24px; border-radius: 28px 28px 0 0; width: 100%; max-width: 500px; box-shadow: 0 5px 30px var(--shadow-color); animation: modalPopIn 0.4s cubic-bezier(0.23, 1, 0.32, 1); }
        @media (min-width: 768px) { .modal-content { border-radius: 20px; border: 1px solid var(--glass-border); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .modal-close-btn, .icon-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .icon-btn:hover { color: var(--text-primary); background-color: var(--surface-2); }
        .modal-body form { display: flex; flex-direction: column; gap: 16px; }
        .modal-body input, .modal-body select, .modal-body textarea { padding: 14px; border: 1px solid var(--border-color); background-color: var(--surface-2); color: var(--text-primary); border-radius: 10px; font-size: 1rem; font-family: var(--font-family); }
        .modal-body textarea { min-height: 120px; resize: vertical; }
        .modal-body .primary-action-btn { padding: 14px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .context-picker { display: flex; align-items: center; gap: 8px; }
        .context-picker input[type="text"] { flex-grow: 1; }
        .context-picker input[type="color"] { background-color: transparent; border: 1px solid var(--border-color); border-radius: 8px; min-width: 48px; height: 48px; padding: 4px; cursor: pointer; }

        /* Profile Modal */
        .profile-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .profile-avatar { width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary); display: flex; align-items:center; justify-content:center; font-size: 1.5rem; font-weight: bold; }
        .profile-info h3 { margin: 0; font-size: 1rem; word-break: break-all; }
        .settings-section { margin-top: 24px; }
        .settings-section h4 { margin: 0 0 12px; color: var(--text-secondary); font-weight: 500; }
        .shortcuts-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: var(--text-secondary); }
        .shortcuts-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0;}
        .shortcuts-list code { background-color: var(--surface-2); border-radius: 4px; padding: 2px 6px; }
        .context-color-setting { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .context-color-setting span { color: var(--text-secondary); }
        .context-color-setting input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-color: transparent; border: 1px solid var(--border-color); border-radius: 8px; 
            width: 40px; height: 32px; padding: 2px; cursor: pointer;
        }
        .context-color-setting input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .context-color-setting input[type="color"]::-webkit-color-swatch { border-radius: 6px; border: none; }
        .context-color-setting input[type="color"]::-moz-color-swatch { border-radius: 6px; border: none; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="toast"></div>

    <script type="module">
        (async function() {
            // --- Setup ---
            const { createClient } = supabase;
            const SUPABASE_URL = 'https://wmuhtcgjcmvwjerxzjdl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtdWh0Y2dqY212d2plcnh6amRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NjEwNDIsImV4cCI6MjA3ODQzNzA0Mn0.tGBe8iOz4YV5i5Gp_seLlkwISBXCO7h5fR-LRzNsAeU';
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- App State ---
            const appState = {
                user: null,
                tasks: [],
                settings: { theme: 'dark', uiDensity: 'default' },
                themeSettings: {
                    contextColors: {
                        'Trabalho': '#3b82f6', 'Freela': '#ef4444',
                        'Faculdade': '#f97316', 'Pessoal': '#8b5cf6',
                    }
                },
                currentView: 'dashboard',
                isLoading: true,
                selectedTask: null,
                gamification: { xp: 0, level: 1, xpToNextLevel: 100 },
            };

            const KANBAN_COLUMNS = {
                'backlog': 'Backlog', 'todo': 'A Fazer',
                'doing': 'Fazendo', 'done': 'Feito'
            };

            // --- UI Components / Rendering ---
            function renderLoginScreen() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="login-container">
                        <div class="login-card">
                            <h1>FocoTotal</h1>
                            <p>Seu sistema para uma vida focada.</p>
                            <form class="login-form" id="login-form">
                                <input type="email" id="email-input" placeholder="seu@email.com" required />
                                <button type="submit">Entrar / Cadastrar</button>
                                <button type="button" id="dev-login-btn" class="dev-login-btn">Entrar como Dev</button>
                            </form>
                        </div>
                    </div>
                `;
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('dev-login-btn').addEventListener('click', handleDevLogin);
            }

            function renderAppShell() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <header class="app-header"></header>
                    <main class="main-content"></main>
                    <nav class="bottom-nav"></nav>
                    <button class="fab" id="fab-add-task">+</button>
                    <div class="modal-overlay" id="add-task-modal"></div>
                    <div class="modal-overlay" id="profile-modal"></div>
                `;
                renderHeader();
                renderBottomNav();
                addShellEventListeners();
            }

            function renderHeader() {
                const header = document.querySelector('.app-header');
                if (!header) return;
                const userInitial = appState.user?.email?.charAt(0).toUpperCase() || '?';
                const { level, xp, xpToNextLevel } = appState.gamification;
                const xpPercentage = (xp / xpToNextLevel) * 100;

                header.innerHTML = `
                    <span class="logo">FocoTotal</span>
                    <div class="header-right">
                        <div class="xp-bar-container">
                            <div class="xp-info">
                                <span>Nível ${level}</span>
                                <span>${xp}/${xpToNextLevel} XP</span>
                            </div>
                            <div class="xp-bar-track">
                                <div class="xp-bar" style="width: ${xpPercentage}%;"></div>
                            </div>
                        </div>
                        <div class="user-avatar" id="user-avatar">${userInitial}</div>
                    </div>
                `;
                 header.querySelector('#user-avatar').addEventListener('click', renderProfileModal);
            }

            function renderBottomNav() {
                 const nav = document.querySelector('.bottom-nav');
                 if (!nav) return;
                 nav.innerHTML = `
                    <button data-view="dashboard" class="${appState.currentView === 'dashboard' ? 'active' : ''}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                        <span>Início</span>
                    </button>
                    <button data-view="kanban" class="${appState.currentView === 'kanban' ? 'active' : ''}">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25A2.25 2.25 0 0 1 5.25 3h4.5M12 3v13.5" /></svg>
                       <span>Tarefas</span>
                    </button>
                `;
                 nav.querySelectorAll('button').forEach(button => button.addEventListener('click', handleNavClick));
            }
            
            function renderDashboard() {
                appState.currentView = 'dashboard';
                const mainContent = document.querySelector('.main-content');
                if (!mainContent) {
                    renderAppShell();
                    renderDashboard();
                    return;
                }
                
                const tasksToDo = appState.tasks.filter(t => t.status === 'todo' || t.status === 'doing').length;
                const tasksDoneToday = appState.tasks.filter(t => t.status === 'done' && new Date(t.updated_at).toDateString() === new Date().toDateString()).length;
                
                mainContent.innerHTML = `
                    <div class="dashboard-grid">
                        <div class="card focus-card">
                            <h1>Olá!</h1>
                            <p>Você tem ${tasksToDo} tarefas pendentes hoje.</p>
                             <div class="stat-grid">
                                <div class="stat-item"><h4>${tasksDoneToday}</h4><p>Feitas Hoje</p></div>
                                <div class="stat-item"><h4>${appState.tasks.filter(t => t.status === 'done').length}</h4><p>Total Feitas</p></div>
                                <div class="stat-item"><h4>${appState.gamification.level}</h4><p>Nível</p></div>
                            </div>
                            <form class="quick-add-form" id="quick-add-form">
                                <input type="text" id="quick-add-input" placeholder="Adicionar tarefa rápida..." required>
                                <button type="submit">+</button>
                            </form>
                        </div>
                        <div class="card">
                            <h2>Progresso Semanal</h2>
                            <div style="height: 200px; position: relative;"><canvas id="progress-chart"></canvas></div>
                        </div>
                    </div>
                `;
                document.getElementById('quick-add-form').addEventListener('submit', handleQuickAddTask);
                renderProgressChart();
            }
            
            function renderKanbanView() {
                appState.currentView = 'kanban';
                const mainContent = document.querySelector('.main-content');
                if (!mainContent) {
                    renderAppShell();
                    renderKanbanView();
                    return;
                }

                mainContent.innerHTML = `<div class="kanban-board"></div>`;
                const board = mainContent.querySelector('.kanban-board');
                
                for (const status in KANBAN_COLUMNS) {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'kanban-column';
                    columnEl.id = `column-${status}`;
                    columnEl.innerHTML = `
                        <div class="kanban-column-header"><h2>${KANBAN_COLUMNS[status]}</h2></div>
                        <div class="task-cards-container" data-status="${status}"></div>
                    `;
                    board.appendChild(columnEl);
                    const container = columnEl.querySelector('.task-cards-container');
                    const tasksInColumn = appState.tasks.filter(task => task.status === status).sort((a,b) => a.order - b.order);
                    
                    if (tasksInColumn.length > 0) {
                        tasksInColumn.forEach(task => container.appendChild(createTaskCardElement(task)));
                    } else {
                        container.innerHTML = `<div class="empty-column-state">Vazio por aqui. Que tal adicionar uma tarefa?</div>`;
                    }
                }
                addKanbanEventListeners();
            }

            function createTaskCardElement(task) {
                const card = document.createElement('div');
                card.className = 'task-card';
                card.id = `task-${task.id}`;
                card.draggable = true;
                card.dataset.taskId = task.id;

                const contextColor = appState.themeSettings.contextColors[task.context] || '#888';
                const contextTag = task.context 
                    ? `<div class="context-tag" style="background-color: ${contextColor};">${DOMPurify.sanitize(task.context)}</div>`
                    : '';
                
                const isDone = task.status === 'done';
                const completeButton = !isDone ? `<button class="complete-task-btn" title="Marcar como Feita">&#10003;</button>` : '';

                card.innerHTML = `
                    <div class="task-header">
                        <h3>${DOMPurify.sanitize(task.title)}</h3>
                        ${completeButton}
                    </div>
                    <p class="description-snippet">${DOMPurify.sanitize(task.description || '').substring(0, 100)}</p>
                    <div class="task-footer">${contextTag}</div>
                `;
                return card;
            }

            function renderAddTaskModal(task = null) {
                const isEditing = task !== null;
                const modalId = 'add-task-modal';
                const modal = document.getElementById(modalId);
                const title = isEditing ? 'Editar Tarefa' : 'Nova Tarefa';
                const buttonText = isEditing ? 'Salvar Alterações' : 'Criar Tarefa';
                const availableContexts = [...new Set(appState.tasks.map(t => t.context).filter(Boolean))];

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${title}</h2>
                            <button class="modal-close-btn" data-modal-id="${modalId}">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="task-form">
                                <input type="hidden" id="task-id" value="${task?.id || ''}">
                                <input type="text" id="task-title" placeholder="Título da tarefa" value="${DOMPurify.sanitize(task?.title || '')}" required>
                                <textarea id="task-description" placeholder="Descrição (suporta Markdown)...">${DOMPurify.sanitize(task?.description || '')}</textarea>
                                <div class="context-picker">
                                    <input type="text" id="task-context" list="context-list" placeholder="Contexto (Trabalho, Pessoal...)" value="${DOMPurify.sanitize(task?.context || '')}">
                                    <datalist id="context-list">${availableContexts.map(c => `<option value="${c}"></option>`).join('')}</datalist>
                                    <input type="color" id="task-context-color" value="${appState.themeSettings.contextColors[task?.context] || '#ffffff'}">
                                </div>
                                <select id="task-status">${Object.entries(KANBAN_COLUMNS).map(([key, value]) => `<option value="${key}" ${task?.status === key ? 'selected' : ''}>${value}</option>`).join('')}</select>
                                <button type="submit" class="primary-action-btn">${buttonText}</button>
                            </form>
                        </div>
                    </div>
                `;
                modal.classList.add('show');
                modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.classList.remove('show'));
                document.getElementById('task-form').addEventListener('submit', handleSaveTask);
                 document.getElementById('task-context').addEventListener('input', (e) => {
                    document.getElementById('task-context-color').value = appState.themeSettings.contextColors[e.target.value] || '#ffffff';
                });
            }
            
            function renderProfileModal() {
                 const modalId = 'profile-modal';
                 const modal = document.getElementById(modalId);
                 const userInitial = appState.user?.email?.charAt(0).toUpperCase() || '?';
                 const uniqueContexts = [...new Set([...appState.tasks.map(t => t.context).filter(Boolean), ...Object.keys(appState.themeSettings.contextColors)])];
                 const contextColorsHTML = uniqueContexts.map(context => `
                    <div class="context-color-setting">
                        <span>${DOMPurify.sanitize(context)}</span>
                        <input type="color" data-context="${DOMPurify.sanitize(context)}" value="${appState.themeSettings.contextColors[context] || '#ffffff'}">
                    </div>`).join('');
                 
                 modal.innerHTML = `
                     <div class="modal-content">
                         <div class="modal-header"><h2>Perfil & Configs</h2><button class="modal-close-btn" data-modal-id="${modalId}">&times;</button></div>
                         <div class="modal-body">
                             <div class="profile-header">
                                 <div class="profile-avatar">${userInitial}</div><div class="profile-info"><h3>${appState.user?.email}</h3></div>
                             </div>
                             <div class="settings-section">
                                <h4>Atalhos</h4>
                                <ul class="shortcuts-list">
                                    <li><span>Nova Tarefa</span><code>N</code></li>
                                    <li><span>Fechar Janela</span><code>Esc</code></li>
                                </ul>
                             </div>
                             <div class="settings-section">
                                 <h4>Cores dos Contextos</h4><div id="context-colors-list">${contextColorsHTML}</div>
                             </div>
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px;">
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">v0.3.0</span>
                                <button id="logout-btn" class="primary-action-btn" style="background: var(--danger); margin-top: 0;">Sair</button>
                             </div>
                         </div>
                     </div>
                 `;
                 modal.classList.add('show');
                 modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.classList.remove('show'));
                 document.getElementById('logout-btn').addEventListener('click', handleLogout);
                 modal.querySelectorAll('#context-colors-list input[type="color"]').forEach(input => input.addEventListener('change', handleContextColorChange));
            }
            
            function renderSkeletonLoader() {
                const mainContent = document.querySelector('.main-content');
                if(!mainContent) return;
                mainContent.innerHTML = `
                    <div class="kanban-board">
                        ${Array.from({length: 4}).map(() => `
                            <div class="kanban-column">
                                <div class="skeleton skeleton-header"></div>
                                <div class="skeleton skeleton-card"></div>
                                <div class="skeleton skeleton-card"></div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            function renderProgressChart() {
                const canvas = document.getElementById('progress-chart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const labels = []; const dateMap = new Map();
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    labels.push(d.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', ''));
                    dateMap.set(d.toISOString().split('T')[0], 0);
                }
                appState.tasks.forEach(task => {
                    if (task.status === 'done' && task.updated_at) {
                        const completedDateKey = new Date(task.updated_at).toISOString().split('T')[0];
                        if (dateMap.has(completedDateKey)) dateMap.set(completedDateKey, dateMap.get(completedDateKey) + 1);
                    }
                });
                const data = Array.from(dateMap.values());
                const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');
                new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Tarefas Concluídas', data: data, backgroundColor: gradient, borderColor: 'var(--primary-glow)', borderWidth: 2, pointBackgroundColor: 'var(--primary-glow)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'var(--border-color)' }, ticks: { color: 'var(--text-secondary)', stepSize: 1 } }, x: { grid: { display: false }, ticks: { color: 'var(--text-secondary)' } } } } });
            }

            // --- Event Handlers & Logic ---
            async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('email-input').value; const { error } = await supabaseClient.auth.signInWithOtp({ email }); if (error) showToast(`Erro: ${error.message}`); else showToast('Link mágico enviado! Verifique seu email.', 'success'); }
            async function handleDevLogin(e) { e.preventDefault(); const devEmail = 'dev@focototal.com', devPassword = 'password'; try { let { error: signUpError } = await supabaseClient.auth.signUp({ email: devEmail, password: devPassword }); if (signUpError) { if (signUpError.message.includes('User already registered')) { let { error: signInError } = await supabaseClient.auth.signInWithPassword({ email: devEmail, password: devPassword }); if (signInError) throw signInError; } else throw signUpError; } } catch (error) { console.error("Erro no login de dev:", error); showToast(`Erro no login: ${error.message}`); } }
            async function handleLogout() { await supabaseClient.auth.signOut(); document.getElementById('profile-modal').classList.remove('show'); renderLoginScreen(); }

            async function handleSaveTask(e) {
                e.preventDefault();
                const form = e.target;
                const taskId = form.querySelector('#task-id').value;
                const taskData = {
                    title: form.querySelector('#task-title').value,
                    description: form.querySelector('#task-description').value,
                    context: form.querySelector('#task-context').value,
                    status: form.querySelector('#task-status').value,
                    user_id: appState.user.id
                };
                
                const contextColor = form.querySelector('#task-context-color').value;
                if (taskData.context && contextColor) {
                    appState.themeSettings.contextColors[taskData.context] = contextColor;
                    await supabaseClient.from('app_state').update({ settings: appState.themeSettings }).eq('user_id', appState.user.id);
                }

                document.getElementById('add-task-modal').classList.remove('show');

                if (taskId) { // Editing
                    const originalTask = appState.tasks.find(t => t.id == taskId);
                    const originalTaskClone = {...originalTask};
                    Object.assign(originalTask, taskData, { id: parseInt(taskId) });
                    updateTaskInUI(originalTask);

                    const { error } = await supabaseClient.from('tasks').update(taskData).eq('id', taskId);
                    if (error) {
                        showToast(`Erro: ${error.message}`);
                        Object.assign(originalTask, originalTaskClone);
                        updateTaskInUI(originalTask);
                    } else showToast('Tarefa atualizada!', 'success');
                } else { // Creating
                    const tempId = `temp-${Date.now()}`;
                    const newTask = { ...taskData, id: tempId, order: 0 };
                    appState.tasks.push(newTask);
                    addTaskToUI(newTask);
                    
                    const { data, error } = await supabaseClient.from('tasks').insert(taskData).select().single();
                    if (error) {
                        showToast(`Erro: ${error.message}`);
                        appState.tasks = appState.tasks.filter(t => t.id !== tempId);
                        removeTaskFromUI(tempId);
                    } else {
                        const finalTask = data;
                        const tempTaskIndex = appState.tasks.findIndex(t => t.id === tempId);
                        appState.tasks[tempTaskIndex] = finalTask;
                        
                        const tempCard = document.getElementById(`task-${tempId}`);
                        if(tempCard) {
                            tempCard.id = `task-${finalTask.id}`;
                            tempCard.dataset.taskId = finalTask.id;
                        }
                        showToast('Tarefa criada!', 'success');
                    }
                }
            }
            
            async function handleQuickAddTask(e) { e.preventDefault(); const input = document.getElementById('quick-add-input'); const title = input.value.trim(); if(!title) return; input.value = ''; const taskData = { title: title, status: 'backlog', user_id: appState.user.id }; const tempId = `temp-${Date.now()}`; const newTask = { ...taskData, id: tempId, order: 0 }; appState.tasks.push(newTask); if(appState.currentView === 'kanban') addTaskToUI(newTask); const { data, error } = await supabaseClient.from('tasks').insert(taskData).select().single(); if(error) { showToast(`Erro: ${error.message}`); appState.tasks = appState.tasks.filter(t => t.id !== tempId); if(appState.currentView === 'kanban') removeTaskFromUI(tempId); } else { const finalTask = data; const tempTaskIndex = appState.tasks.findIndex(t => t.id === tempId); appState.tasks[tempTaskIndex] = finalTask; const tempCard = document.getElementById(`task-${tempId}`); if(tempCard) { tempCard.id = `task-${finalTask.id}`; tempCard.dataset.taskId = finalTask.id; } showToast('Tarefa rápida adicionada!', 'success'); renderDashboard(); } }
            function handleTaskClick(e) { const card = e.target.closest('.task-card'); if (card && !e.target.closest('.complete-task-btn')) { const task = appState.tasks.find(t => t.id == card.dataset.taskId); renderAddTaskModal(task); } }
            async function handleContextColorChange(e) { const context = e.target.dataset.context; const newColor = e.target.value; appState.themeSettings.contextColors[context] = newColor; try { const { error } = await supabaseClient.from('app_state').upsert({ user_id: appState.user.id, settings: appState.themeSettings }, { onConflict: 'user_id' }); if (error) throw error; if(appState.currentView === 'kanban') renderKanbanView(); } catch (error) { showToast(`Erro ao salvar cor: ${error.message}`); } }
            function handleNavClick(e) { const view = e.currentTarget.dataset.view; if (view === appState.currentView) return; appState.currentView = view; renderBottomNav(); if (view === 'dashboard') renderDashboard(); else if (view === 'kanban') renderKanbanView(); }
            async function handleQuickCompleteTask(taskId) {
                const task = appState.tasks.find(t => t.id == taskId);
                if (!task || task.status === 'done') return;

                const oldStatus = task.status;
                task.status = 'done';

                const cardElement = document.getElementById(`task-${taskId}`);
                const doneColumn = document.querySelector('.task-cards-container[data-status="done"]');
                if (cardElement && doneColumn) {
                    cardElement.style.animation = 'fadeOut 0.3s forwards';
                    setTimeout(() => {
                        doneColumn.appendChild(cardElement);
                        updateTaskInUI(task); // Re-render card without complete button
                        cardElement.style.animation = 'slideUp 0.4s ease-out';
                    }, 300);
                }
                
                addXp(10);
                
                const { error } = await supabaseClient.from('tasks').update({ status: 'done' }).eq('id', taskId);
                if (error) {
                    showToast(`Erro: ${error.message}`);
                    task.status = oldStatus;
                    const oldColumn = document.querySelector(`.task-cards-container[data-status="${oldStatus}"]`);
                    if(oldColumn && cardElement) {
                        oldColumn.appendChild(cardElement);
                        updateTaskInUI(task);
                    }
                }
            }

            // --- Drag and Drop ---
            let draggedItemId = null;
            function addKanbanEventListeners() {
                document.querySelectorAll('.task-card').forEach(card => {
                    card.addEventListener('dragstart', (e) => { draggedItemId = e.target.dataset.taskId; setTimeout(() => e.target.classList.add('dragging'), 0); });
                    card.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                    card.addEventListener('click', handleTaskClick);
                    const completeBtn = card.querySelector('.complete-task-btn');
                    if(completeBtn) completeBtn.addEventListener('click', () => handleQuickCompleteTask(card.dataset.taskId));
                });
                document.querySelectorAll('.task-cards-container').forEach(container => {
                    container.addEventListener('dragover', e => { e.preventDefault(); const afterElement = getDragAfterElement(container, e.clientY); const draggable = document.querySelector('.dragging'); if (afterElement == null) { container.appendChild(draggable); } else { container.insertBefore(draggable, afterElement); } });
                    container.addEventListener('dragenter', e => e.currentTarget.classList.add('drag-over-active'));
                    container.addEventListener('dragleave', e => e.currentTarget.classList.remove('drag-over-active'));
                    container.addEventListener('drop', e => { e.currentTarget.classList.remove('drag-over-active'); handleTaskDrop(e); });
                });
            }
            function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }
            async function handleTaskDrop(e) {
                e.preventDefault();
                const container = e.target.closest('.task-cards-container');
                if (!container || !draggedItemId) return;
                
                const newStatus = container.dataset.status;
                const droppedTask = appState.tasks.find(t => t.id == draggedItemId);
                const oldStatus = droppedTask.status;
                if (oldStatus === newStatus) return;

                droppedTask.status = newStatus;
                if(newStatus === 'done' && oldStatus !== 'done') addXp(10);
                updateTaskInUI(droppedTask);
                
                const { error } = await supabaseClient.from('tasks').update({ status: newStatus }).eq('id', draggedItemId);
                if (error) {
                    showToast(`Erro: ${error.message}`);
                    droppedTask.status = oldStatus;
                    const oldColumn = document.querySelector(`.task-cards-container[data-status="${oldStatus}"]`);
                    const cardElement = document.getElementById(`task-${draggedItemId}`);
                    if(oldColumn && cardElement) oldColumn.appendChild(cardElement);
                } else showToast('Tarefa movida!', 'success');
            }

            // --- UI Update Helpers ---
            function addTaskToUI(task) {
                const column = document.querySelector(`.task-cards-container[data-status="${task.status}"]`);
                if (column) {
                    const emptyState = column.querySelector('.empty-column-state');
                    if (emptyState) emptyState.remove();
                    const cardElement = createTaskCardElement(task);
                    column.appendChild(cardElement);
                    addKanbanEventListeners(); // Re-attach listeners for the new card
                }
            }
            function removeTaskFromUI(taskId) { document.getElementById(`task-${taskId}`)?.remove(); }
            function updateTaskInUI(task) {
                const card = document.getElementById(`task-${task.id}`);
                if (card) {
                    const newCard = createTaskCardElement(task);
                    card.replaceWith(newCard);
                    addKanbanEventListeners(); // Re-attach listeners
                }
            }
            
            function addXp(amount) {
                appState.gamification.xp += amount;
                if (appState.gamification.xp >= appState.gamification.xpToNextLevel) {
                    appState.gamification.level++;
                    appState.gamification.xp -= appState.gamification.xpToNextLevel;
                    appState.gamification.xpToNextLevel = Math.floor(appState.gamification.xpToNextLevel * 1.5);
                    showToast(`Nível ${appState.gamification.level} alcançado!`, 'success');
                } else {
                    showToast(`+${amount} XP!`, 'success');
                }
                renderHeader();
            }

            function addShellEventListeners() {
                document.getElementById('fab-add-task').addEventListener('click', () => renderAddTaskModal());
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal-overlay.show').forEach(modal => modal.classList.remove('show'));
                    }
                    if (e.key.toLowerCase() === 'n' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        renderAddTaskModal();
                    }
                });
            }
            function showToast(message, type = '') { const toast = document.getElementById('toast'); toast.textContent = message; toast.className = type; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }

            async function loadInitialData() {
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (!user) throw new Error("Usuário não autenticado");
                    appState.user = user;

                    const [tasksResponse, settingsResponse] = await Promise.all([
                        supabaseClient.from('tasks').select('*').order('order'),
                        supabaseClient.from('app_state').select('settings').eq('user_id', user.id).single()
                    ]);

                    if (tasksResponse.error) throw tasksResponse.error;
                    appState.tasks = tasksResponse.data;
                    
                    if (settingsResponse.data?.settings) {
                        appState.themeSettings = { ...appState.themeSettings, ...settingsResponse.data.settings };
                    }

                    renderDashboard();
                    renderBottomNav();
                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                    showToast(`Erro: ${error.message}`);
                    renderLoginScreen();
                }
            }

            function init() {
                document.getElementById('app').innerHTML = `<div id="initial-loader"></div>`;
                renderAppShell();
                renderSkeletonLoader();

                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN') {
                        appState.user = session.user;
                        loadInitialData();
                    } else if (event === 'SIGNED_OUT') {
                        appState.user = null;
                        renderLoginScreen();
                    }
                });
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        appState.user = session.user;
                        loadInitialData();
                    } else renderLoginScreen();
                }).catch(error => {
                    console.error("Erro ao verificar sessão:", error);
                    renderLoginScreen();
                });
            }
            init();
        })();
    </script>
</body>
</html>